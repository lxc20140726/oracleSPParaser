# Oracleå­˜å‚¨è¿‡ç¨‹åˆ†æå·¥å…· - æµ‹è¯•æ–‡æ¡£

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

æœ¬é¡¹ç›®åŒ…å«äº†å…¨é¢çš„æµ‹è¯•å¥—ä»¶ï¼Œæ¶µç›–å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€APIæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ç­‰å¤šä¸ªæ–¹é¢ï¼Œç¡®ä¿Oracleå­˜å‚¨è¿‡ç¨‹åˆ†æå·¥å…·çš„è´¨é‡å’Œå¯é æ€§ã€‚

## ğŸ§ª æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ __init__.py                 # æµ‹è¯•åŒ…åˆå§‹åŒ–
â”œâ”€â”€ conftest.py                 # pytesté…ç½®å’Œå…¬å…±fixtures
â”œâ”€â”€ README.md                   # æµ‹è¯•è¯´æ˜æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ unit/                       # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_parser.py         # å­˜å‚¨è¿‡ç¨‹è§£æå™¨æµ‹è¯•
â”‚   â””â”€â”€ test_analyzers.py      # åˆ†æå™¨ç»„ä»¶æµ‹è¯•
â”œâ”€â”€ integration/                # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_end_to_end.py     # ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_complex_sp.py     # å¤æ‚å­˜å‚¨è¿‡ç¨‹æµ‹è¯•ï¼ˆå·²å­˜åœ¨ï¼‰
â”‚   â””â”€â”€ debug_*.py             # è°ƒè¯•è„šæœ¬ï¼ˆå·²å­˜åœ¨ï¼‰
â”œâ”€â”€ api/                        # APIæµ‹è¯•
â”‚   â””â”€â”€ test_backend_api.py    # åç«¯APIæµ‹è¯•
â”œâ”€â”€ performance/                # æ€§èƒ½æµ‹è¯•
â”‚   â””â”€â”€ test_performance.py    # æ€§èƒ½å’Œå‹åŠ›æµ‹è¯•
â””â”€â”€ data/                       # æµ‹è¯•æ•°æ®
    â””â”€â”€ sample_procedures.py   # ç¤ºä¾‹å­˜å‚¨è¿‡ç¨‹æ•°æ®
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…æµ‹è¯•ä¾èµ–

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
pip install -r requirements-test.txt

# æˆ–è€…ä½¿ç”¨æµ‹è¯•è„šæœ¬è‡ªåŠ¨å®‰è£…
python run_tests.py --setup
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python run_tests.py --all

# è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•
python run_tests.py --unit        # å•å…ƒæµ‹è¯•
python run_tests.py --integration # é›†æˆæµ‹è¯•
python run_tests.py --api         # APIæµ‹è¯•
python run_tests.py --performance # æ€§èƒ½æµ‹è¯•

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python run_tests.py --coverage
```

## ğŸ“Š æµ‹è¯•ç±»å‹è¯¦è§£

### ğŸ”§ å•å…ƒæµ‹è¯• (Unit Tests)

**ä½ç½®**: `tests/unit/`

**ç›®æ ‡**: æµ‹è¯•å„ä¸ªç»„ä»¶çš„ç‹¬ç«‹åŠŸèƒ½

**åŒ…å«æµ‹è¯•**:
- **è§£æå™¨æµ‹è¯•** (`test_parser.py`)
  - å­˜å‚¨è¿‡ç¨‹ç»“æ„è§£æ
  - å‚æ•°æå–
  - SQLè¯­å¥è¯†åˆ«
  - é”™è¯¯å¤„ç†
  - æ€§èƒ½æµ‹è¯•

- **åˆ†æå™¨æµ‹è¯•** (`test_analyzers.py`)
  - å‚æ•°åˆ†æå™¨
  - è¡¨å­—æ®µåˆ†æå™¨
  - æ¡ä»¶åˆ†æå™¨
  - æ•°æ®æµåˆ†æ

**è¿è¡Œæ–¹å¼**:
```bash
python run_tests.py --unit
# æˆ–è€…
pytest tests/unit/ -v
```

### ğŸ”— é›†æˆæµ‹è¯• (Integration Tests)

**ä½ç½®**: `tests/integration/`

**ç›®æ ‡**: æµ‹è¯•ç»„ä»¶é—´çš„åä½œå’Œå®Œæ•´å·¥ä½œæµ

**åŒ…å«æµ‹è¯•**:
- **ç«¯åˆ°ç«¯æµ‹è¯•** (`test_end_to_end.py`)
  - å®Œæ•´åˆ†æå·¥ä½œæµ
  - å¤æ‚å­˜å‚¨è¿‡ç¨‹å¤„ç†
  - é”™è¯¯æ¢å¤æµ‹è¯•
  - æ•°æ®æµåˆ†æ
  - å‚æ•°ä¼ æ’­æµ‹è¯•
  - å¹¶å‘åˆ†ææµ‹è¯•
  - å†…å­˜ä½¿ç”¨æµ‹è¯•

**è¿è¡Œæ–¹å¼**:
```bash
python run_tests.py --integration
# æˆ–è€…
pytest tests/integration/ -v
```

### ğŸŒ APIæµ‹è¯• (API Tests)

**ä½ç½®**: `tests/api/`

**ç›®æ ‡**: æµ‹è¯•åç«¯APIæ¥å£çš„åŠŸèƒ½å’Œæ€§èƒ½

**åŒ…å«æµ‹è¯•**:
- **åç«¯APIæµ‹è¯•** (`test_backend_api.py`)
  - å¥åº·æ£€æŸ¥ç«¯ç‚¹
  - å­˜å‚¨è¿‡ç¨‹åˆ†æç«¯ç‚¹
  - æ–‡ä»¶ä¸Šä¼ åˆ†æ
  - é”™è¯¯å¤„ç†
  - è¾“å…¥éªŒè¯
  - å¹¶å‘è¯·æ±‚å¤„ç†
  - APIå®‰å…¨æ€§
  - å“åº”æ ¼å¼éªŒè¯

**è¿è¡Œæ–¹å¼**:
```bash
python run_tests.py --api
# æˆ–è€…
pytest tests/api/ -v
```

### âš¡ æ€§èƒ½æµ‹è¯• (Performance Tests)

**ä½ç½®**: `tests/performance/`

**ç›®æ ‡**: æµ‹è¯•ç³»ç»Ÿçš„æ€§èƒ½ã€å†…å­˜ä½¿ç”¨å’Œç¨³å®šæ€§

**åŒ…å«æµ‹è¯•**:
- **åˆ†ææ€§èƒ½æµ‹è¯•**
  - å•æ¬¡åˆ†ææ€§èƒ½
  - å¤§å‹å­˜å‚¨è¿‡ç¨‹å¤„ç†
  - å†…å­˜ä½¿ç”¨ç›‘æ§
  - å¹¶å‘åˆ†ææ€§èƒ½
  - CPUå¯†é›†å‹æµ‹è¯•
  - å†…å­˜æ³„æ¼æ£€æµ‹

- **APIæ€§èƒ½æµ‹è¯•**
  - å“åº”æ—¶é—´æµ‹è¯•
  - å¹¶å‘è¯·æ±‚æµ‹è¯•
  - ååé‡æµ‹è¯•

**è¿è¡Œæ–¹å¼**:
```bash
python run_tests.py --performance
# æˆ–è€…
pytest tests/performance/ -v -s
```

## ğŸ”§ æµ‹è¯•é…ç½®

### pytest.ini é…ç½®

æµ‹è¯•é…ç½®æ–‡ä»¶åŒ…å«ä»¥ä¸‹è®¾ç½®ï¼š
- æµ‹è¯•è·¯å¾„å’Œæ–‡ä»¶æ¨¡å¼
- è¦†ç›–ç‡æŠ¥å‘Šé…ç½®
- è¶…æ—¶è®¾ç½®
- æµ‹è¯•æ ‡è®°å®šä¹‰
- è­¦å‘Šè¿‡æ»¤

### æµ‹è¯•æ ‡è®° (Markers)

é¡¹ç›®ä½¿ç”¨ä»¥ä¸‹æµ‹è¯•æ ‡è®°æ¥åˆ†ç±»æµ‹è¯•ï¼š

- `@pytest.mark.unit` - å•å…ƒæµ‹è¯•
- `@pytest.mark.integration` - é›†æˆæµ‹è¯•
- `@pytest.mark.api` - APIæµ‹è¯•
- `@pytest.mark.performance` - æ€§èƒ½æµ‹è¯•
- `@pytest.mark.slow` - æ…¢é€Ÿæµ‹è¯•
- `@pytest.mark.smoke` - å†’çƒŸæµ‹è¯•

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# åªè¿è¡Œå•å…ƒæµ‹è¯•
pytest -m "unit"

# æ’é™¤æ…¢é€Ÿæµ‹è¯•
pytest -m "not slow"

# è¿è¡Œç‰¹å®šæ ‡è®°çš„æµ‹è¯•
pytest -m "api and not slow"
```

### å…¬å…±Fixtures

`conftest.py` æä¾›äº†ä»¥ä¸‹å…¬å…±fixturesï¼š

- `oracle_sp_analyzer` - OracleSPAnalyzerå®ä¾‹
- `fastapi_app` - FastAPIåº”ç”¨å®ä¾‹
- `sample_stored_procedure` - ç¤ºä¾‹å­˜å‚¨è¿‡ç¨‹
- `complex_stored_procedure` - å¤æ‚å­˜å‚¨è¿‡ç¨‹
- `mock_database_tables` - æ¨¡æ‹Ÿæ•°æ®åº“è¡¨ç»“æ„
- `test_data_generator` - æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨

## ğŸ“ˆ è¦†ç›–ç‡æŠ¥å‘Š

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Š
python run_tests.py --coverage

# æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š
open test_results/coverage_html/index.html
```

### è¦†ç›–ç‡ç›®æ ‡

- **æ•´ä½“è¦†ç›–ç‡**: > 85%
- **æ ¸å¿ƒæ¨¡å—è¦†ç›–ç‡**: > 90%
- **å…³é”®è·¯å¾„è¦†ç›–ç‡**: 100%

## ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½åè§„èŒƒ

```python
def test_åŠŸèƒ½æè¿°_æœŸæœ›ç»“æœ():
    """æµ‹è¯•æè¿°"""
    pass

# ç¤ºä¾‹
def test_parse_simple_procedure_returns_correct_structure():
    """æµ‹è¯•è§£æç®€å•å­˜å‚¨è¿‡ç¨‹è¿”å›æ­£ç¡®ç»“æ„"""
    pass
```

### 2. ä½¿ç”¨å‚æ•°åŒ–æµ‹è¯•

```python
@pytest.mark.parametrize("input_value,expected_output", [
    ("input1", "output1"),
    ("input2", "output2"),
])
def test_parametrized_function(input_value, expected_output):
    assert function(input_value) == expected_output
```

### 3. æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–

```python
@patch('module.external_dependency')
def test_with_mock(mock_dependency):
    mock_dependency.return_value = "mocked_result"
    # æµ‹è¯•ä»£ç 
```

### 4. å¼‚æ­¥æµ‹è¯•

```python
@pytest.mark.asyncio
async def test_async_function():
    result = await async_function()
    assert result is not None
```

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### 1. æµ‹è¯•ç¯å¢ƒé—®é¢˜

**é—®é¢˜**: ä¾èµ–åŒ…å®‰è£…å¤±è´¥
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ›´æ–°pipå’Œsetuptools
pip install --upgrade pip setuptools
pip install -r requirements-test.txt
```

**é—®é¢˜**: è·¯å¾„å¯¼å…¥é”™è¯¯
```bash
# è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿é¡¹ç›®æ ¹ç›®å½•åœ¨Pythonè·¯å¾„ä¸­
export PYTHONPATH="${PYTHONPATH}:$(pwd)"
```

### 2. æµ‹è¯•å¤±è´¥åˆ†æ

**æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯**:
```bash
pytest --tb=long -v
```

**åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•**:
```bash
pytest --lf
```

**è°ƒè¯•å•ä¸ªæµ‹è¯•**:
```bash
pytest tests/unit/test_parser.py::TestStoredProcedureParser::test_parse_simple_procedure -v -s
```

### 3. æ€§èƒ½æµ‹è¯•é—®é¢˜

**é—®é¢˜**: æ€§èƒ½æµ‹è¯•è¶…æ—¶
- å¢åŠ è¶…æ—¶æ—¶é—´: `pytest --timeout=600`
- æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

**é—®é¢˜**: å†…å­˜ä½¿ç”¨è¿‡é«˜
- æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
- å‡å°‘æµ‹è¯•æ•°æ®è§„æ¨¡

## ğŸ“‹ æµ‹è¯•æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] æ‰€æœ‰æ–°åŠŸèƒ½éƒ½æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°è¦æ±‚
- [ ] æ‰€æœ‰æµ‹è¯•éƒ½èƒ½é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•æ²¡æœ‰å›å½’
- [ ] APIæµ‹è¯•éªŒè¯äº†æ‰€æœ‰ç«¯ç‚¹
- [ ] é”™è¯¯å¤„ç†æœ‰ç›¸åº”æµ‹è¯•
- [ ] æµ‹è¯•ä»£ç éµå¾ªé¡¹ç›®è§„èŒƒ

## ğŸ”„ æŒç»­é›†æˆ

é¡¹ç›®æ”¯æŒæŒç»­é›†æˆï¼Œæ¯æ¬¡ä»£ç æäº¤éƒ½ä¼šè‡ªåŠ¨è¿è¡Œï¼š

1. **å¿«é€Ÿæ£€æŸ¥** - å†’çƒŸæµ‹è¯•å’Œå•å…ƒæµ‹è¯•
2. **å…¨é¢æµ‹è¯•** - åŒ…æ‹¬é›†æˆæµ‹è¯•å’ŒAPIæµ‹è¯•
3. **æ€§èƒ½å›å½’** - æ€§èƒ½åŸºå‡†æµ‹è¯•
4. **è¦†ç›–ç‡æŠ¥å‘Š** - ç”Ÿæˆå¹¶æ›´æ–°è¦†ç›–ç‡æŠ¥å‘Š

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†
2. æ£€æŸ¥æµ‹è¯•æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
3. åœ¨é¡¹ç›®ä»“åº“ä¸­æäº¤issue
4. è”ç³»å¼€å‘å›¢é˜Ÿè·å–æ”¯æŒ

---

**è®°ä½**: å¥½çš„æµ‹è¯•æ˜¯é«˜è´¨é‡è½¯ä»¶çš„åŸºç¡€ï¼ ğŸš€ 